---
title: "Untitled"
author: "Sahil, Ariel, Ilya, Lekha, Anthony, Trang"
date: "4/26/2021"
output: pdf_document
---

## Introduction

Anthony.

## Loading R packages

Anthony and Trang please list why each package is used.

```{r}
library(foreign)
library(readxl)
library(ggplot2)
library(grid)
library(quadprog)
library(rugarch)
library(rmgarch)
library(quantmod)
library(e1071)
library(gridExtra)
library(zoo)
library(fGarch)
library(dynlm)
library(tidyverse)
library(fGarch)
library(FinTS)
theme_set(theme_bw())
```

## Formula and Basics

Anthony.

## Data description

Anthony and Ariel.

```{r}
# FB data-set
fb <- getSymbols("FB", auto.assign = F)
nrow(fb) # Gives you the number of data points

# FB data-set
fb.df <- as.data.frame(fb)
fb_train_data = fb.df[1:2100,]
fb_test_data = fb.df[2100:2247,]

# Renaming the phantom "Date" column
fb.df <- cbind(Date = rownames(fb.df), fb.df)
rownames(fb.df) <- 1:nrow(fb.df)
```


## Visualization

Ilya, can you write 1-2 sentences about the visualization?

```{r}
# FB data-set
chartSeries(fb) # Plots the time series
```

## Analysis

```{r}
# FB data-set
fb_plot_1 <- ggplot(fb.df, aes(y = FB.Adjusted, x = Date)) + geom_line(col = 'blue', group = 1) + labs(ylab = 'return', xlab = 'Time', title = 'Adjusted Returns')

grid.arrange(fb_plot_1, ncol = 2);
```

```{r}
# FB data-set
# Examine the FB's daily stock returns trend
fb.df$Date <- seq.Date(as.Date('2010-01-01'), by = 'day', length.out = length(fb.df$FB.Adjusted))
ggplot(fb.df, aes(y = FB.Adjusted, x = Date )) + geom_line(col = 'red', group = 1) +
  labs(title = 'FB daily Stock Returns', ylab = 'return')
```

## Model Evaluation

```{r}
# Step 1: Estimate mean equation r = beta + error
fb_data_mean <- dynlm(FB.Adjusted ~ 1, data = fb.df)

# Step 2: Retrieve the residuals from the former model and square them
ehatsq <- ts(resid(fb_data_mean)^2)

# Step 3: regress squared residuals on one-lagged squared residuals
fb_data_arch <- dynlm(ehatsq ~ L(ehatsq), data = ehatsq)

summary(fb_data_arch)
```


```{r}
# FB data-set
fb_data_archTest <- ArchTest(fb.df$FB.Adjusted, lags = 1, demean = TRUE)
fb_data_archTest

#Reject Null Hypothesis
```
Because the p-value is < 0.05, we reject the null hypothesis and conclude the presence of ARCH(1) effects.

```{r}
# FB data-set
# Plot the conditional variance
fb_arch_fit <- garchFit(~garch(1,0), data = fb.df$FB.Adjusted, trace = F)

summary(fb_arch_fit)

fb_pred <- predict(fb_arch_fit, n.ahead = 100, trace = TRUE, mse = c("cond","uncond"),
        plot=TRUE, nx=NULL, crit_val=NULL, conf=NULL)

summary(fb_pred)

fb.df$ht <- fb_arch_fit@h.t
# How to rename the first column as "Date"?
ggplot(fb.df, aes(y = ht, x = Date)) + geom_line(col = '#ff9933', group = 1) + ylab('Conditional Variance') + xlab('Date')
```
Looking at the graph, you can see the periods in which volatility was high.

## Prediction and Model Accuracy

```{r}
# FB data-set
# We can change the armaOrder to create different models and keep the model with lowest AIC!

# 1st Model
fb1 <- ugarchspec(variance.model = list(model = "sGARCH", garchOrder = c(1, 1)), mean.model = list(armaOrder = c(1, 1)), distribution.model = "std")

fbGarch1 <- ugarchfit(spec = fb1, data = fb.df$FB.Adjusted)

# 2nd Model: AIC = 10.432
fb2 <- ugarchspec(variance.model = list(model = "sGARCH", garchOrder = c(1, 1)), mean.model = list(armaOrder = c(0, 0)), distribution.model = "std")

fbGarch2 <- ugarchfit(spec = fb2, data = fb.df$FB.Adjusted)

# 3rd Model: AIC =  4.2241
fb3 <- ugarchspec(variance.model = list(model = "sGARCH", garchOrder = c(1, 1)), mean.model = list(armaOrder = c(1, 0)), distribution.model = "std")

fbGarch3 <- ugarchfit(spec = fb3, data = fb.df$FB.Adjusted)

# 4th Model: AIC = 9.2361
fb4 <- ugarchspec(variance.model = list(model = "sGARCH", garchOrder = c(1, 1)), mean.model = list(armaOrder = c(0, 1)), distribution.model = "std")

fbGarch4 <- ugarchfit(spec = fb4, data = fb.df$FB.Adjusted)
```
From the above computations, we say that fGarch 3 was a better model as it has an AIC = 4.2241, which is the lowest amongst the rest. We will use this model to make predictions.

Ilya does the forecasting. (Ariel can help)
```{r}
# FB data-set 
# Finally forecast whatever you want!
# This is an example of what you want to forecast where n.ahead is the number of predictions you want to make and fbGarch3 is an example for the model that you want to use.
fbPredict <- ugarchboot(fbGarch3, n.ahead = 10, method = c("Partial", "Full")[1])
plot(fbPredict, which = 2)
```

## Conclusion

Trang and Lekha

## Reference

https://rpubs.com/cyobero/arch

